<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: Room.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: Room.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

//const SocketIO = require("socket.io")

/**
 * @typedef {Object} User
 * @property {String} Name
 * @property {String} SocketID
 */

class Room {

    /** 新しいルームを作成
     * @constructor
     * @classdesc ルームを管理
     * @param {String} roomid ルームID
     * @param {Games} parent 親クラス
     */
    constructor(roomid, parent){
        /** 
         * 入室しているルームID
         * @type {String} */
        this.roomid = roomid

        /** 
         * 親クラス
         * @type {Games}*/
        this.parent = parent

        /**
         * 状態
         * @type {Boolean}*/
        this.status = false

        /** 
         * ルームのオーナー
         * @type {Array.&lt;User>}*/
        this.owners = [];

        /**
         * ルームに参加しているユーザ
         * @type {Array.&lt;User>} */
        this.users = [];

        /** 
         * ゲームの終了時間
         * @type {NodeJS.Timeout}*/
        this.stoptimer = null;

        // /** @type {Set.&lt;String>} */
        // this.Clients = parent.io.sockets.adapter.rooms.get(roomid);
    }

    /**
     * メッセージを受け取るためのsocket.ioのListenerを追加 
     * @param {SocketIO.Socket} socket
     */
    addListeners(socket){
        socket.on("sendTo",(arg)=>{this.SendTo(arg.SocketID,arg.arg)})
    }

    /**
     * メッセージを受け取るためのsocket.ioのListenerを削除
     * @param {SocketIO.Socket} socket
     */
    removeListeners(socket){
        socket.off("sendTo",(arg)=>{this.SendTo(arg.SocketID,arg.arg)})
    }

    /** socket(送信元)以外に送信
     * @param {SocketIO.Socket} socket 
     * @param {String} param
     * @param {Object} arg 送信するデータ
     */
    Broadcast(socket,param,...arg){
        socket.broadcast.to(this.roomid).emit(param,...arg)
    }

    /** 全員に送信
     * @param {String} param 
     * @param {Object} arg 送信するデータ
     */
    SendToAll(param,...arg){
        this.parent.io.to(this.roomid).emit(param,...arg)
    }

    /** 特定の相手に送信
     * @param {String} destid ルームID 
     * @param {Object} arg 送信するデータ
     */
    SendTo(destid, arg){
        this.parent.io.to(destid).emit("sentToMe",arg)
        console.log(arg,destid)
    }
    
    /** ルームに参加
     * @param {SocketIO.Socket} socket 
     * @param {String} username
     */
    Join(socket,username){
        let currentroom = this.parent.getRoomidFromSocket(socket)
        if( currentroom != socket.id){
            console.log("joined and leaved")
            this.parent.rooms.get(currentroom).Leave(socket);
        }
        socket.join(this.roomid);
        this.users.push({Name:username?username:"Anon",SocketID:socket.id})
        socket.once("disconnect",()=>{
            this.Leave(socket)
        })
        this.addListeners(socket)
    }
    /** ルームから離脱
     * @param {SocketIO.Socket} socket 
     */
    Leave(socket){
        socket.leave(this.roomid)
        this.users = this.users.filter((user)=> {
            return user.SocketID != socket.id;
        });
        this.owners = this.owners.filter((user)=> {
            return user.SocketID != socket.id;
        });
        if (this.users.length == 0){
            this.parent.DeleteGame(this.roomid)
        }
        this.removeListeners(socket)
    }
    /** ゲームの情報を返す
     * @param {SocketIO.Socket} socket 
     */
    getGameInfo(socket){
        let stat
        if(this.status){
            stat = "started"
        }else{
            stat = "stopped"
        }
        let res = {"status":stat,"roomid":this.roomid,"users":this.users,"myID":socket.id}
        return res
    }
    
    /** ゲームの情報をセットする(GameStart,GameEnd,...etc)
     * @param {SocketIO.Socket} socket 
     */
    setGameInfo(socket,info){
        if(JSON.stringify(this.owners.filter(user=>{return user.SocketID === socket.id}))==="[]"){//オーナーの一覧にいなければ
            return {"status":"failed","message":"You dont have permission"}
        }
        let res = {}
        let startat = Date.now()
        let duration = info.duration
        const timer = () =>{
            if(this.status){
                this.status=false
                let res = {"status":"stop","message":"game finished"}
                this.SendToAll("gameInfo",res)
            }
        }
        if(info.StartGame){
            if(!this.status){
                //{}にゲーム情報ぶち込む
                this.status=true
                res = {"status":"start","message":"game started","startat":startat,"duration":duration}
                this.SendToAll("gameInfo",res)
                this.stoptimer = setTimeout(timer, duration);
            }else{
                res = {"status":"started","message":"game already started"}
            }
        } else if(info.StopGame){
            if(this.status){
                this.status=false
                res = {"status":"stop","message":"game finished"}
                this.SendToAll("gameInfo",res)
                clearTimeout(this.stoptimer);
            }else{
                res = {"status":"stopped","message":"game already finished"}
            }
        }
        return res
    }
}
exports.Room = Room
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Games.html">Games</a></li><li><a href="Room.html">Room</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.10</a> on Tue Feb 22 2022 18:58:19 GMT+0900 (日本標準時)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
